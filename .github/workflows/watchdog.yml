name: Watchdog_gha_prod_monitoring_wf_queued

on:
  schedule:
    - cron: "*/5 * * * *"   # every 5 minutes
  workflow_dispatch:

jobs:
  monitor-queued:
    runs-on: ubuntu-latest
    steps:
      - name: Check queued runs of blank.yml
        id: check
        run: |
          echo "Checking queued runs for blank.yml"
          # Get runs of blank.yml workflow
          runs=$(gh api repos/${{ github.repository }}/actions/workflows/blank.yml/runs \
            --jq '.workflow_runs[] | select(.status=="queued") | "\(.id) \(.run_number) \(.created_at)"')
          
          stale=""
          now=$(date -u +%s)
          for run in $runs; do
            id=$(echo $run | awk '{print $1}')
            num=$(echo $run | awk '{print $2}')
            created=$(echo $run | awk '{print $3}')
            created_sec=$(date -d "$created" +%s)
            diff=$(( (now - created_sec) / 60 ))
            if [ $diff -ge 5 ]; then
              echo "Run $num (ID $id) has been queued for $diff minutes"
              stale="$stale\n- Workflow blank.yml (Run ID: $id, Number: $num) queued since $created"
            fi
          done
          
          echo -e "$stale" > issue.md
          if [ -n "$stale" ]; then
            echo "stale_found=true" >> $GITHUB_ENV
          else
            echo "stale_found=false" >> $GITHUB_ENV
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create or update GitHub Issue if stale
        if: env.stale_found == 'true'
        uses: peter-evans/create-issue-from-file@v5
        with:
          title: ⚠️ Queued job stuck > 5 minutes (blank.yml)
          content-filepath: issue.md
          labels: bug, watchdog
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}

      - name: Close Issue if no stale jobs
        if: env.stale_found == 'false'
        run: |
          issue_number=$(gh issue list \
            --repo ${{ github.repository }} \
            --search "Queued job stuck > 5 minutes (blank.yml) in:title state:open" \
            --json number --jq '.[0].number')
          if [ -n "$issue_number" ]; then
            gh issue close $issue_number --repo ${{ github.repository }} \
              --comment "✅ All jobs are healthy. Closing watchdog alert."
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
