name: Watchdog_gha_prod_monitoring_queued
on:
  schedule:
    - cron: "*/5 * * * *"   # Run every 5 minutes
  workflow_dispatch:        # Allow manual trigger

jobs:
  check-queued-jobs:
    name: Check queued jobs
    runs-on: ubuntu-latest
    outputs:
      has-stale-jobs: ${{ steps.check.outputs.has-stale-jobs }}
      issue-body: ${{ steps.check.outputs.issue-body }}
    steps:
      - name: Check for queued jobs older than 5 minutes
        id: check
        run: |
          # Fetch workflow runs with status=queued
          runs=$(gh api repos/${{ github.repository }}/actions/runs \
            --jq '.workflow_runs[] | select(.status=="queued") | {id: .id, name: .name, created_at: .created_at}' \
            --paginate)

          echo "Found runs:"
          echo "$runs"

          stale_jobs=""
          issue_body=""
          cutoff=$(date -u -d "5 minutes ago" +%s)

          while IFS= read -r run; do
            id=$(echo "$run" | jq -r '.id')
            name=$(echo "$run" | jq -r '.name')
            created=$(echo "$run" | jq -r '.created_at')
            created_ts=$(date -d "$created" +%s)
            if [ "$created_ts" -lt "$cutoff" ]; then
              stale_jobs="yes"
              issue_body="$issue_body\n- Workflow **$name** (Run ID: $id) has been queued since $created"
            fi
          done <<< "$(echo "$runs" | jq -c '.')"

          if [ -n "$stale_jobs" ]; then
            echo "has-stale-jobs=true" >> $GITHUB_OUTPUT
            echo "issue-body<<EOF" >> $GITHUB_OUTPUT
            echo -e "$issue_body" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "has-stale-jobs=false" >> $GITHUB_OUTPUT
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify:
    name: Create GitHub Issue if stale jobs found
    needs: check-queued-jobs
    if: needs.check-queued-jobs.outputs.has-stale-jobs == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Write issue body to file
        run: |
          echo "⚠️ Queued job(s) stuck for more than 5 minutes:" > issue.md
          echo "${{ needs.check-queued-jobs.outputs.issue-body }}" >> issue.md

      - uses: peter-evans/create-issue-from-file@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          title: ⚠️ Queued job stuck for more than 5 minutes
          content-filepath: issue.md
          labels:  watchdog
