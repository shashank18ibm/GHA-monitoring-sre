name: Watchdog - Monitor gha-pord-worflow Status

on:
  schedule:
    - cron: "*/5 * * * *"   # every 5 minutes
  workflow_dispatch:

jobs:
  monitor-blank:
    runs-on: ubuntu-latest
    steps:
      - name: Check queued runs of blank.yml
        id: check
        run: |
          echo "Checking queued runs for blank.yml..."
          
          # Get workflow runs for blank.yml with status=queued
          runs=$(gh api repos/${{ github.repository }}/actions/workflows/blank.yml/runs \
            --jq '.workflow_runs[] | select(.status=="queued") | {id: .id, run_number: .run_number, created_at: .created_at}' )
          
          echo "Found runs:"
          echo "$runs"

          # Default: no stale jobs
          echo "stale_found=false" >> $GITHUB_ENV

          if [ -z "$runs" ]; then
            echo "No queued runs found."
            exit 0
          fi

          cutoff=$(date -u -d "5 minutes ago" +%s)
          issue_body=""
          while IFS= read -r run; do
            id=$(echo "$run" | jq -r '.id')
            num=$(echo "$run" | jq -r '.run_number')
            created=$(echo "$run" | jq -r '.created_at')
            created_ts=$(date -d "$created" +%s)
            if [ "$created_ts" -lt "$cutoff" ]; then
              issue_body="$issue_body\n- Workflow **blank.yml** (Run ID: $id, Number: $num) queued since $created"
            fi
          done <<< "$(echo "$runs" | jq -c '.')"

          if [ -n "$issue_body" ]; then
            echo "⚠️ Queued job(s) stuck for more than 5 minutes:" > issue.md
            echo -e "$issue_body" >> issue.md
            echo "stale_found=true" >> $GITHUB_ENV
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Issue if stale jobs
        if: env.stale_found == 'true'
        uses: peter-evans/create-issue-from-file@v5
        with:
          title: ⚠️ Queued job stuck > 5 minutes (blank.yml)
          content-filepath: issue.md
          labels: watchdog
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}

      - name: Close Issue if queue is healthy
        if: env.stale_found == 'false'
        run: |
          issue_number=$(gh issue list \
            --repo ${{ github.repository }} \
            --search "Queued job stuck > 5 minutes (blank.yml) in:title state:open" \
            --json number --jq '.[0].number')
          if [ -n "$issue_number" ]; then
            gh issue close $issue_number --repo ${{ github.repository }} \
              --comment "✅ All blank.yml runs are healthy. Closing watchdog alert."
          else
            echo "No open watchdog issue found."
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
