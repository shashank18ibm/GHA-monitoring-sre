name: Deployment Watchdog (Scheduled)

on:
  schedule:
    - cron: "*/5 * * * *"   # runs every 5 minutes

jobs:
  watchdog:
    runs-on: ubuntu-latest
    steps:
      - name: Check recent workflow runs
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # üëá Change this to the exact name of your main workflow (file or name)
          MAIN_WORKFLOW="blank.yml"

          echo "üîç Checking workflow: $MAIN_WORKFLOW"

          # Get last 5 runs of this workflow
          runs=$(gh api repos/${{ github.repository }}/actions/workflows/${MAIN_WORKFLOW}.yml/runs \
            --jq '.workflow_runs[0:5] | map({status: .status, conclusion: .conclusion, created_at: .created_at, id: .id})')

          echo "Runs: $runs"

          # Extract queued runs
          queued=$(echo "$runs" | jq -c '.[] | select(.status=="queued")')
          if [ -z "$queued" ]; then
            echo "‚úÖ No queued runs found"
            exit 0
          fi

          # Check if any queued run is older than 30 minutes
          now=$(date -u +%s)
          alert=0
          while IFS= read -r run; do
            created=$(echo "$run" | jq -r .created_at)
            ts=$(date -u -d "$created" +%s)
            age=$(( (now - ts) / 60 ))
            if [ "$age" -gt 30 ]; then
              echo "üö® Workflow stuck in queue for $age minutes! Run: $run"
              alert=1
            fi
          done <<< "$queued"

          if [ "$alert" -eq 1 ]; then
            exit 1
          else
            echo "‚ÑπÔ∏è Queued runs are recent (<30min)"
          fi
